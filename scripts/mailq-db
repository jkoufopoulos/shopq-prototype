#!/bin/bash
# MailQ Tracking Database Explorer
# Quick access to tracking data with common queries

DB="mailq_tracking.db"

if [ ! -f "$DB" ]; then
    echo "âŒ Database not found: $DB"
    echo "Run a digest first to create the tracking database"
    exit 1
fi

# If no args, open interactive sqlite
if [ $# -eq 0 ]; then
    echo "ðŸ“Š Opening MailQ tracking database..."
    echo "Tip: See docs/SQL_GUIDE.md for example queries"
    sqlite3 -column -header "$DB"
    exit 0
fi

# Quick commands
case "$1" in
    sessions)
        echo "ðŸ“‹ Recent Sessions:"
        sqlite3 -column -header "$DB" "
            SELECT
                session_id,
                COUNT(*) as threads,
                MIN(received_date) as first_email,
                MAX(received_date) as last_email
            FROM email_threads
            GROUP BY session_id
            ORDER BY session_id DESC
            LIMIT 10;
        "
        ;;

    latest)
        echo "ðŸ“Š Latest Session Summary:"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        echo "Session: $SESSION"
        echo ""
        sqlite3 -column -header "$DB" "
            SELECT
                importance,
                COUNT(*) as count,
                SUM(entity_extracted) as with_entities,
                SUM(in_featured) as featured,
                SUM(verifier_used) as verified
            FROM email_threads
            WHERE session_id = '$SESSION'
            GROUP BY importance;
        "
        ;;

    importance)
        echo "ðŸ’¡ Importance Reasons (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                importance,
                importance_reason,
                COUNT(*) as count
            FROM email_threads
            WHERE session_id = '$SESSION'
            GROUP BY importance, importance_reason
            ORDER BY importance, count DESC;
        "
        ;;

    entities)
        echo "ðŸŽ¯ Entity Extraction (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                importance,
                COUNT(*) as total,
                SUM(entity_extracted) as extracted,
                ROUND(SUM(entity_extracted) * 100.0 / COUNT(*), 1) as success_rate
            FROM email_threads
            WHERE session_id = '$SESSION'
            GROUP BY importance;
        "
        echo ""
        echo "Failed extractions (important only):"
        sqlite3 -column -header "$DB" "
            SELECT
                subject,
                importance,
                importance_reason
            FROM email_threads
            WHERE session_id = '$SESSION'
                AND entity_extracted = 0
                AND importance != 'routine'
            LIMIT 10;
        "
        ;;

    verifier)
        echo "ðŸ” Verifier Usage (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                subject,
                email_type,
                type_confidence,
                verifier_verdict,
                verifier_reason
            FROM email_threads
            WHERE session_id = '$SESSION'
                AND verifier_used = 1
            ORDER BY verifier_verdict;
        "
        ;;

    digest)
        echo "ðŸ“ Digest Breakdown (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                CASE
                    WHEN in_featured = 1 THEN 'Featured'
                    WHEN in_orphaned = 1 THEN 'Orphaned'
                    WHEN in_noise = 1 THEN 'Noise'
                    ELSE 'Not Included'
                END as section,
                COUNT(*) as count
            FROM email_threads
            WHERE session_id = '$SESSION'
            GROUP BY section;
        "
        echo ""
        echo "Noise categories:"
        sqlite3 -column -header "$DB" "
            SELECT
                noise_category,
                COUNT(*) as count
            FROM email_threads
            WHERE session_id = '$SESSION'
                AND in_noise = 1
            GROUP BY noise_category
            ORDER BY count DESC;
        "
        ;;

    critical)
        echo "âš ï¸  Critical Emails (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                subject,
                from_email,
                importance_reason,
                entity_type,
                in_featured
            FROM email_threads
            WHERE session_id = '$SESSION'
                AND importance = 'critical'
            ORDER BY received_date;
        "
        ;;

    unlinked)
        echo "âŒ Unlinked Summary Lines (Latest Session):"
        SESSION=$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")
        sqlite3 -column -header "$DB" "
            SELECT
                subject,
                summary_line
            FROM email_threads
            WHERE session_id = '$SESSION'
                AND summary_line IS NOT NULL
                AND summary_linked = 0;
        "
        ;;

    export)
        SESSION=${2:-$(sqlite3 "$DB" "SELECT MAX(session_id) FROM email_threads;")}
        OUTPUT="mailq_session_${SESSION}.csv"
        echo "ðŸ’¾ Exporting session $SESSION to $OUTPUT..."
        sqlite3 -csv -header "$DB" "SELECT * FROM email_threads WHERE session_id = '$SESSION';" > "$OUTPUT"
        echo "âœ… Exported to $OUTPUT"
        ;;

    help|--help|-h)
        cat << EOF
ðŸ“Š MailQ Database Explorer

USAGE:
    ./mailq-db [command]

COMMANDS:
    (no args)       Open interactive SQLite shell
    sessions        List recent sessions
    latest          Summary of latest session
    importance      Show importance breakdown and reasons
    entities        Entity extraction analysis
    verifier        Show verifier usage and decisions
    digest          Digest inclusion breakdown
    critical        Show critical emails
    unlinked        Show unlinked summary lines (validation errors)
    export [ID]     Export session to CSV (defaults to latest)
    help            Show this help

EXAMPLES:
    ./mailq-db                    # Open interactive shell
    ./mailq-db latest             # Quick session summary
    ./mailq-db entities           # See entity extraction stats
    ./mailq-db export             # Export latest session
    ./mailq-db export 20251028    # Export specific session

For advanced queries, see: docs/SQL_GUIDE.md
EOF
        ;;

    *)
        echo "âŒ Unknown command: $1"
        echo "Run './mailq-db help' for usage"
        exit 1
        ;;
esac
