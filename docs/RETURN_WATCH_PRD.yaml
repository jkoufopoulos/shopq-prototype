return_watch:
  version: "0.4"
  doc_type: "v1_locked_requirements"
  product_name: "Return Watch"
  product_promise: >
    Show a clean list of real purchases (one card per order) and alert users when a return window
    is closing. Return Watch only includes orders with a known return deadline. Purchases is the
    complete list (including unknown deadlines).

  phases:
    v1:
      ship_goal: "Purchases list + Return Watch filter + alerts"
      excludes:
        - "policy database"
        - "advanced dedup beyond primary keys"
        - "logistics actions (courier/pickup)"
    v1_5_optional:
      - "Preloaded return window presets for top merchants (clearly labeled estimated)"
    v2_optional:
      - "Scraped/maintained policy database for popular merchants"

  core_user_stories:
    - id: US1
      story: "As a user, I want to see only purchases I've made so that I can decide which to return."
    - id: US2
      story: "As a user, I want to know when a return window is closing so that I can make the return and not lose money."

  scope:
    in_scope:
      - "Detect purchases from Gmail messages and create Order cards"
      - "Show ONE card per order (dedupe emails into orders using primary keys only)"
      - "Compute return deadlines: exact from email; estimated from user merchant rules; unknown otherwise"
      - "Return Watch shows only orders with known deadlines"
      - "Alerts for expiring deadlines (sorted by soonest)"
      - "1-tap link back to source email; return portal link if extracted"
      - "User can mark returned or dismiss to reduce noise"
    out_of_scope:
      - "Completing returns (courier, pickup scheduling, refunds, disputes)"
      - "Guessing deadlines from scraped policies in v1"
      - "Secondary/fuzzy order merging (amount/date heuristics) in v1"

  terminology:
    message: "A Gmail email message."
    order: "A purchase entity formed by clustering messages."
    card: "The UI representation of an order."
    deadline_confidence:
      exact: "Explicit return-by date in email"
      estimated: "Computed from user merchant return-window days + anchor date"
      unknown: "No usable info to compute deadline"

  # -----------------------------
  # 1) DATA + LOGIC REQUIREMENTS (V1 LOCKED)
  # -----------------------------
  logic:
    L1_purchase_detection:
      requirement: >
        Only create an Order when a purchase is confirmed. Do not create orders for promos,
        carts, newsletters, or shipping-only messages that cannot be linked to an existing order.
      purchase_evidence:
        strong_any_of:
          - "order_id_present == true"
          - "total_amount_present == true"
          - "purchase_confirmation_phrase_present == true"
      create_order_rules:
        create_order_if:
          - "strong_any_of is true"
          - "OR (purchase_confirmation_phrase_present == true AND total_amount_present == true)"
        do_not_create_order_if:
          - "promo_only == true AND strong_any_of is false"
          - "cart_or_wishlist_only == true AND strong_any_of is false"
          - "shipping_update_only == true AND cannot_link_to_existing_order == true"
      clarifications:
        - "Do NOT exclude solely because message contains 'unsubscribe' (footer noise)."
      acceptance_criteria:
        - id: AC_L1_1
          given: "Promo email with discount language + unsubscribe, no order id, no amount"
          then: "No order created"
        - id: AC_L1_2
          given: "Order confirmation with order number OR total amount"
          then: "Order created"
        - id: AC_L1_3
          given: "Shipping update with tracking but no purchase evidence and no link to existing order"
          then: "No order created"
        - id: AC_L1_4
          given: "Shipping/delivery update with an order_id matching an existing order"
          then: "Message is linked to that existing order (no new order created)"

    L2_order_deduplication_v1:
      requirement: >
        Return Watch and Purchases must show ONE card per order, not one row per email.
        V1 dedup is PRIMARY-KEY ONLY (no fuzzy secondary merging).
      order_identity_keys:
        primary_only:
          - "merchant_id + order_id"
          - "merchant_id + tracking_number"
      merge_policy:
        on_primary_match: "merge messages into one order"
        otherwise: "create separate order"
      acceptance_criteria:
        - id: AC_L2_1
          given: "5 delivery status emails containing the same order_id"
          then: "Only one card appears; messages are merged into that order"
        - id: AC_L2_2
          given: "Two purchases from same merchant on same day with no order_id/tracking_number"
          then: "They remain separate orders (no merge)"

    L3_return_deadline_computation_v1:
      requirement: >
        Compute return deadlines with strict precedence. Never present estimates as facts.
        V1 estimates come ONLY from user merchant rules or explicit 'X-day' language in the email.
      anchor_date_priority:
        - "delivery_date"
        - "purchase_date"
      precedence:
        - id: P1
          name: "Exact return-by date found"
          rule: "If email explicitly states a return-by date/deadline tied to return language."
          confidence: "exact"
        - id: P2
          name: "Estimated from return-window days in email"
          rule: "If email states 'X-day returns' AND anchor_date exists."
          confidence: "estimated"
        - id: P3
          name: "Estimated from user merchant rule"
          rule: "If user has merchant_rule_days AND anchor_date exists."
          confidence: "estimated"
        - id: P4
          name: "Unknown"
          rule: "Otherwise"
          confidence: "unknown"
      alert_safety_rule:
        # Prevent catastrophic incorrect alerts when delivery date is missing.
        alerts_require:
          - "deadline_confidence == exact OR delivery_date exists"
      acceptance_criteria:
        - id: AC_L3_1
          given: "Email contains 'Return by Feb 10'"
          then: "deadline=Feb 10, confidence=exact"
        - id: AC_L3_2
          given: "Email contains '30-day returns' and delivery date is known"
          then: "deadline=delivery+30, confidence=estimated"
        - id: AC_L3_3
          given: "No return info and no user rule"
          then: "deadline unknown; do not alert"
        - id: AC_L3_4
          given: "Estimated deadline computed from purchase_date because delivery_date missing"
          then: "deadline may display as estimated, but alerts do NOT fire (safety rule)"

    L4_alerts_and_priority_v1:
      requirement: "Only alert on orders with known deadlines; sort alerts by soonest deadline."
      threshold_days_default: 7
      eligibility:
        must_have:
          - "deadline_date exists"
          - "deadline_confidence in [exact, estimated]"
          - "order_status not in [returned, dismissed]"
        must_satisfy_safety_rule:
          - "deadline_confidence == exact OR delivery_date exists"
      triggers:
        - name: "enter_expiring_window"
          when: "days_remaining <= threshold_days_default AND previously > threshold_days_default"
          send: true
        - name: "one_day_remaining"
          when: "days_remaining == 1"
          send: "optional"
      priority_sort:
        - "deadline_date ASC"
        - "deadline_confidence exact before estimated"
      acceptance_criteria:
        - id: AC_L4_1
          given: "Two expiring orders at 2 days and 6 days"
          then: "2-day order appears above 6-day order"
        - id: AC_L4_2
          given: "Unknown deadline order"
          then: "No alert is sent"

  merchant_rules:
    requirement: "Users can set a merchant-level return window (days) to enable estimated deadlines."
    v1_behavior:
      where_user_sets_rule:
        - "Order detail screen (recommended)"
      prompt_strategy:
        - "No forced prompts. Show a subtle CTA when deadline is unknown: 'Set return window for this merchant'."
      allowed_values_days:
        - 30
        - 60
        - 90
        - "custom"
      anchor_preference_default: "delivery_if_available_else_purchase"

  # -----------------------------
  # 2) UI REQUIREMENTS (V1 LOCKED)
  # -----------------------------
  ui:
    navigation:
      requirement: "Two tabs are required in V1: Purchases (default) and Return Watch."
      tabs:
        - id: T1
          name: "Purchases"
          default: true
          definition: "All confirmed purchases (including unknown deadlines)."
        - id: T2
          name: "Return Watch"
          default: false
          definition: "Only purchases with a known deadline (exact or estimated)."

    purchases_screen:
      requirement: "Show all confirmed purchases. No shipping-only noise."
      list_sort:
        - "purchase_date DESC"
      card_minimum_fields:
        - merchant_display_name
        - item_summary
        - purchase_date_display
        - deadline_display_or_unknown
      behavior_notes:
        - "Unknown deadlines are allowed here."
        - "No 'Active Returns (N)' label anywhere on this screen."

    return_watch_screen:
      requirement: "Show only orders with known deadlines and prioritize by soonest expiry."
      sections:
        - name: "Expiring Soon"
          filter: "deadline_date exists AND days_remaining <= threshold_days_default"
          sort: "deadline_date ASC"
        - name: "Active"
          filter: "deadline_date exists AND days_remaining > threshold_days_default"
          sort: "deadline_date ASC"
      empty_state:
        title: "No returns to watch"
        body: "We'll alert you when a return deadline is coming up."
        secondary_action: "View Purchases"

    order_card_minimum:
      requirement: "Cards must be legible and actionable with minimal info."
      fields_required:
        - merchant_display_name
        - item_summary
        - deadline_display   # Return Watch: always a date; Purchases: date or 'Unknown'
      fields_optional:
        - days_remaining
        - delivery_or_purchase_date_display
        - confidence_badge

    order_detail_screen:
      requirement: "One screen that lets the user complete the return by jumping to the source."
      fields_required:
        - merchant_display_name
        - item_summary
        - deadline_display_or_unknown
        - confidence_badge
        - open_source_email_link
      fields_optional:
        - return_portal_link
        - order_number_copy
        - tracking_link
      acceptance_criteria:
        - id: AC_UI_DETAIL_1
          given: "Return portal link not extracted"
          then: "Open source email is available in 1 tap"

    user_controls:
      requirement: "Users must be able to remove noise and stop alerts."
      controls:
        - name: "Mark returned"
          effects:
            - "order_status = returned"
            - "hide from Return Watch"
            - "stop alerts"
        - name: "Dismiss"
          effects:
            - "order_status = dismissed"
            - "hide from Purchases and Return Watch"
            - "stop alerts"

  # -----------------------------
  # 3) DATA MODEL (MINIMAL V1)
  # -----------------------------
  data_model_minimal:
    order:
      required:
        - order_key
        - merchant_id
        - merchant_display_name
        - item_summary
        - purchase_date
        - source_email_ids
        - order_status          # active | returned | dismissed
      optional:
        - delivery_date
        - order_id
        - tracking_number
        - amount
        - currency
        - return_portal_link
    deadline:
      required:
        - order_key
        - deadline_confidence   # exact | estimated | unknown
      optional:
        - deadline_date
        - evidence_text_short

  # -----------------------------
  # 4) QUALITY BARS (SHIP-READY, NOT PERFECTION)
  # -----------------------------
  quality_bars:
    QB1_purchase_precision:
      target: ">= 90% of items shown in Purchases are true purchases"
      measurement: "manual labeling on a golden set"
    QB2_no_duplicate_cards:
      target: "No repeated cards for the same primary-key order"
      measurement: "duplicate_rate_by_primary_key_order < 5%"
    QB3_return_watch_not_empty:
      target: "Return Watch contains at least some known deadlines for heavy shoppers"
      measurement: ">= 20% of Purchases have exact or estimated deadlines (initial benchmark)"

  current_ui_failures_to_fix:
    - "Do not list emails; list orders (dedup)."
    - "Do not label unknown-deadline items as 'returns'. Put them in Purchases."
    - "Do not show repeated Whole Foods shipping statuses as separate cards."
    - "Normalize merchant display names (no quotes like \"Amazon.com\")."
