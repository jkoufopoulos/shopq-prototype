# Phase 0.5 Completion Changelog

**Date**: November 30, 2025
**Session**: Claude Code assisted development session

## Overview

This session completed the Phase 0.5 architecture cleanup, fixing test failures, consolidating the V2 digest pipeline, and removing ~30,000 lines of deprecated code.

## Commits Made

### 1. `e3ab54d` - refactor: Phase 0.5 Architecture Cleanup
- Initial architecture cleanup commit (made before this session)

### 2. `0397f81` - fix(classification): Add importance_conf field and fix type mapper path
- Added `importance_conf` field to `ClassificationContract` in `mailq/storage/classification.py`
- Fixed `TypeMapper` path resolution (was looking in `mailq/config/` instead of `config/`)
- Fixed `propose_rule` default values to use strings instead of booleans
- Fixed `VertexGeminiClassifier._fallback_result()` to use "uncategorized" type

### 3. `07b8dc5` - test: Fix test suite for V2 pipeline and archive deprecated tests
- Added `tests/archive/conftest.py` to exclude archived tests from collection
- Added `tests/manual/conftest.py` for manual tests
- Archived deprecated test files:
  - `test_rules_engine.py`
  - `test_rules_engine_pooled.py`
  - `test_hybrid_digest_integration.py`
  - `test_importance_baseline.py`
  - `test_importance_classifier_fixes.py`
  - `test_temporal_e2e.py`
  - `test_temporal_pipeline_integration.py`
- Updated test assertions for V2 pipeline result structure
- Fixed import paths in multiple test files

### 4. `aae7f65` - refactor(digest): Complete V2 pipeline consolidation
**Major deletions (~3,500 lines)**:
- `mailq/digest/categorizer.py`
- `mailq/digest/context_enricher.py`
- `mailq/digest/formatting.py`
- `mailq/digest/hybrid_digest_renderer.py`
- `mailq/digest/llm_section_classifier.py`
- `mailq/classification/importance_classifier.py`
- `mailq/classification/importance/heuristics.py`
- `mailq/llm/prompts/section_assignment_prompt.txt`

**Code quality fixes**:
- Fixed undefined `logger` in `extractor.py` (moved definition before use)
- Fixed E501 line-too-long errors in `context_digest.py`, `temporal.py`
- Fixed B904 raise-from in `database.py`
- Fixed ARG001/ARG002 unused arguments with `_` prefix
- Fixed SIM102 nested if statements in `temporal.py`
- Fixed SIM108 if-else to ternary in `redaction.py`

### 5. `fe438d3` - docs: Update architecture documentation for V2 pipeline
- Updated `T0_T1_TEMPORAL_ARCHITECTURE.md`
- Updated `T0_T1_IMPORTANCE_CLASSIFICATION.md`
- Updated `TAXONOMY.md`
- Moved deprecated `importance_deciders.md` to archive

### 6. `9f28fed` - feat(extension): Update classification to use consolidated types
- Updated `classifier.js` with V2 pipeline integration
- Updated `detectors.js` with improved pattern matching
- Updated `mapper.js` to use new `MailQ-*` label format
- Updated extension tests

### 7. `387d712` - chore: Archive and remove outdated reports
**Deleted ~26,000 lines of outdated reports**:
- Phase 2 planning documents
- Old experiment reports from 2024-11 and 2025-01
- Archived reference documents
- Added `reports/.gitignore`

### 8. `d97f024` - chore: Update scripts for V2 pipeline compatibility
- Added `# ruff: noqa` to archived/legacy scripts
- Fixed Python 3.11 syntax compatibility in `evaluate_temporal_decay.py`
- Added new eval tools:
  - `gds_correction_tool.py`
  - `generate_error_report.py`
  - `generate_error_report_by_source.py`
  - `importance_review_tool.py`

### 9. `ec78ed5` - docs: Update project documentation for Phase 0.5
- Updated `ROADMAP.md`
- Updated `claude.md`
- Updated `SECURITY_REVIEW.md`
- Updated `.env.example`

### 10. `0013a6c` - chore: Add data/evals gitignore and correction notes
- Added `data/evals/.gitignore`
- Added `gds_correction_notes.md`
- Added `gds_skipped_corrections.txt`

### 11. `d8587f4` - fix(temporal): Fix unused user_timezone argument in decay functions
- Renamed `user_timezone` to `_user_timezone` in `apply_temporal_decay`
- Renamed `user_timezone` to `_user_timezone` in `apply_temporal_decay_batch`
- Removed unused argument from call site

### 12. `10e1dfa` - docs: Add DIGEST_PIPELINE.md documenting V2 pipeline architecture
- Created comprehensive 7-stage pipeline documentation
- Documented all stages, data structures, and entry points

## Files Modified Summary

| Category | Files Changed | Lines Added | Lines Deleted |
|----------|---------------|-------------|---------------|
| mailq/ core | 38 | ~650 | ~4,100 |
| tests/ | 20+ | ~500 | ~1,500 |
| docs/ | 6 | ~530 | ~80 |
| extension/ | 5 | ~370 | ~270 |
| reports/ | 75 | ~420 | ~26,150 |
| scripts/ | 14 | ~2,400 | ~30 |
| config/ | 4 | ~650 | ~640 |

**Total**: ~150 files changed, ~30,000+ lines removed (net reduction)

## Test Status

- **459 tests passing**
- 50 tests skipped (archived/deprecated)
- 35 warnings (pytest return value warnings, non-critical)

## Key Architecture Changes

### V2 Digest Pipeline (7 Stages)
1. TemporalExtractionStage - Filter expired, extract temporal context
2. T0SectionAssignmentStage - Intrinsic section based on type/importance
3. T1TemporalDecayStage - Time-based section adjustment
4. EntityStage - Extract structured entities
5. EnrichmentStage - Weather, greeting, relative time
6. SynthesisAndRenderingStage - HTML generation
7. ValidationStage - Link and schema validation

### Removed Components
- Hybrid digest renderer (replaced by V2 pipeline)
- LLM section classifier (replaced by T0/T1 rules)
- Importance classifier (consolidated into Gemini output)
- Context enricher (merged into EnrichmentStage)

## How to View Git History

```bash
# View all commits for this session
git log --oneline e3ab54d^..HEAD

# View detailed changes per commit
git show <commit-hash>

# View file-level changes
git diff e3ab54d^..HEAD --stat

# View changes to specific file
git log --follow -p -- mailq/digest/context_digest.py
```

## Session Notes

- Session started with 29 failing tests after computer shutdown
- All tests restored to passing (459/459)
- Pre-commit hooks (ruff, mypy) all passing
- No secrets detected in any commit
