# Bridge Mapping Configuration (v2.0)
# Unified configuration for importance mapping and guardrails
# Replaces: config/mapper_rules.yaml + mailq/bridge/guardrails.py

version: 2.0

# 4-Tier Importance Model
# -----------------------
# urgent         → Immediate action required (minutes to hours)
# critical       → Important but not time-critical (days to weeks)
# time_sensitive → Track but not urgent (awareness, planning)
# routine        → Informational only (no action needed)

importance_levels:
  urgent:
    gmail_labels:
      - "IMPORTANT"
      - "STARRED"
    description: "Immediate action required (minutes to hours)"
    examples:
      - "Meeting starting in 30 minutes"
      - "Payment due today"
      - "Security alert requiring immediate action"
      - "Flight departure in 2 hours"

  critical:
    gmail_labels:
      - "IMPORTANT"
    description: "Important but not time-critical (days to weeks)"
    examples:
      - "Bill due in 3 days"
      - "Meeting tomorrow"
      - "Important decision needed this week"
      - "Deadline in 5 days"

  time_sensitive:
    gmail_labels:
      - "CATEGORY_UPDATES"
    description: "Track but not urgent (awareness, planning)"
    examples:
      - "Event next week"
      - "Delivery arriving in 3 days"
      - "Upcoming deadline (> 7 days)"
      - "Meeting scheduled for next month"

  routine:
    gmail_labels: []
    description: "Informational only (no action needed)"
    examples:
      - "Newsletter"
      - "Receipt confirmation"
      - "OTP code (already used)"
      - "Auto-pay confirmation"

# Guardrails: Force-override LLM classification
# ----------------------------------------------
# These rules run BEFORE LLM classification and override results

guardrails:

  # Force URGENT (immediate action required)
  force_urgent:
    - name: security_breach
      reason: "Security breaches require immediate action"
      patterns:
        subject_any:
          - "data breach"
          - "security alert"
          - "account compromised"
          - "unauthorized access"
          - "suspicious activity"
          - "password reset required"

    - name: payment_due_today
      reason: "Payment due today is time-critical"
      patterns:
        subject_any:
          - "payment due today"
          - "bill due today"
          - "final notice"
          - "overdue"
          - "past due"
        attention: "action_required"

    - name: event_starting_soon
      reason: "Events starting within 1 hour are urgent"
      patterns:
        types_any: ["event"]
        temporal_start_within_hours: 1  # Requires temporal enrichment

  # Force CRITICAL (important, not immediate)
  force_critical:
    - name: fraud_alert
      reason: "Fraud alerts are critical but not necessarily immediate"
      patterns:
        subject_any:
          - "fraud alert"
          - "unusual activity"
          - "verify transaction"
        domains_any: ["finance"]

    - name: deadline_this_week
      reason: "Deadlines within 7 days are critical"
      patterns:
        types_any: ["deadline"]
        temporal_start_within_days: 7

  # Force TIME_SENSITIVE
  force_time_sensitive:
    - name: upcoming_delivery
      reason: "Deliveries arriving soon need tracking"
      patterns:
        subject_any:
          - "arriving"
          - "out for delivery"
          - "delivery scheduled"
        domains_any: ["shopping"]

    - name: calendar_event
      reason: "Calendar events are time-sensitive by nature"
      patterns:
        types_any: ["event"]

  # Force ROUTINE (downgrade from LLM classification)
  force_routine:
    - name: otp_codes
      reason: "OTP codes are routine (expire quickly)"
      patterns:
        types_any: ["otp"]  # Match by canonical EmailType
        subject_any:
          - "verification code"
          - "one-time password"
          - "otp"
          - "login code"

    - name: autopay_confirmation
      reason: "Autopay confirmations are informational"
      patterns:
        subject_any:
          - "autopay"
          - "auto-pay"
          - "automatic payment"

    - name: newsletters
      reason: "Newsletters are bulk content"
      patterns:
        types_any: ["newsletter"]

    - name: promotions
      reason: "Promotional emails are routine"
      patterns:
        types_any: ["promotion"]

    - name: receipts
      reason: "Receipts are confirmations only"
      patterns:
        types_any: ["receipt"]

    - name: shipping_confirmation
      reason: "Shipping confirmations are informational"
      patterns:
        subject_any:
          - "order confirmed"
          - "order placed"
          - "order received"
        domains_any: ["shopping"]

  # Skip classification (don't send to LLM)
  skip_classification:
    - name: unsubscribe_emails
      reason: "Email management is not worth classifying"
      patterns:
        subject_any:
          - "unsubscribe"
          - "manage preferences"
          - "email settings"

# Pattern Matching Configuration
# -------------------------------

pattern_matching:
  case_sensitive: false
  match_mode: "substring"  # substring | exact | regex

  # Subject matching
  subject_tokenization: true  # Tokenize subject for better matching

  # Temporal matching (requires temporal enrichment)
  temporal_enabled: true
  temporal_thresholds:
    urgent_hours: 1        # Events starting within 1 hour → urgent
    critical_days: 7       # Deadlines within 7 days → critical
    time_sensitive_days: 30  # Events within 30 days → time_sensitive

# Mapper Rules (LLM → Importance)
# --------------------------------
# These rules apply AFTER LLM classification (if not overridden by guardrails)

mapper_rules:
  - name: action_required_deadline
    importance: critical
    reason: "Action required + deadline = critical"
    when:
      attention: "action_required"
      types_any: ["deadline"]
      exclude_subject:
        - "autopay"
        - "verification code"

  - name: action_required_generic
    importance: time_sensitive
    reason: "Action required without deadline is time_sensitive"
    when:
      attention: "action_required"

  - name: awareness_event
    importance: time_sensitive
    reason: "Events requiring awareness are time_sensitive"
    when:
      attention: "awareness"
      types_any: ["event"]

  - name: fyi_notification
    importance: routine
    reason: "FYI notifications are routine"
    when:
      attention: "fyi"

# Migration Notes
# ---------------
# From mapper_rules.yaml:
#   - 3-tier model (critical, time_sensitive, routine) → 4-tier (urgent, critical, time_sensitive, routine)
#   - Separate guardrails.py logic → Unified YAML config
#
# From mailq/bridge/guardrails.py:
#   - Hardcoded guardrail patterns → YAML patterns
#   - Force-critical / force-routine logic → force_urgent / force_critical / force_time_sensitive / force_routine
#
# Benefits:
#   - Single source of truth for bridge mapping
#   - Easy to tune without code changes
#   - Temporal logic expressed declaratively
#   - Clear separation: guardrails (override) vs mapper_rules (LLM-based)
